name: Publish to crates.io

# Standalone workflow for publishing to crates.io
# This can be triggered independently of the full release process
# Useful for republishing or fixing crates.io releases without rebuilding everything

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip running tests (use with caution)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  publish-crates:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Verify version consistency
        id: version
        run: |
          CARGO_VERSION=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[0].version')
          PYTHON_VERSION=$(grep '^version = ' pyproject.toml | sed 's/version = "\(.*\)"/\1/')

          echo "Cargo.toml version: $CARGO_VERSION"
          echo "pyproject.toml version: $PYTHON_VERSION"

          if [ "$CARGO_VERSION" != "$PYTHON_VERSION" ]; then
            echo "ERROR: Version mismatch between Cargo.toml ($CARGO_VERSION) and pyproject.toml ($PYTHON_VERSION)"
            exit 1
          fi

          echo "version=$CARGO_VERSION" >> $GITHUB_OUTPUT

      - name: Check if version exists on crates.io
        id: check_version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Checking if version $VERSION exists on crates.io..."

          # Search for the exact version
          if cargo search par-term-emu-core-rust --limit 1 | grep -q "par-term-emu-core-rust = \"$VERSION\""; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "⚠️  Version $VERSION already exists on crates.io"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "✓ Version $VERSION not found on crates.io, proceeding with publish"
          fi

      - name: Run Rust tests
        if: ${{ !inputs.skip_tests && steps.check_version.outputs.exists == 'false' }}
        run: cargo test --lib --no-default-features

      - name: Dry run publish
        if: steps.check_version.outputs.exists == 'false'
        run: cargo publish --dry-run

      - name: Publish to crates.io
        if: steps.check_version.outputs.exists == 'false'
        run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Version already exists
        if: steps.check_version.outputs.exists == 'true'
        run: |
          echo "::notice::Version ${{ steps.version.outputs.version }} already exists on crates.io. Skipping publish."

      - name: Discord notification
        if: success() && steps.check_version.outputs.exists == 'false'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        uses: Ilshidur/action-discord@master
        with:
          args: 'Published {{ EVENT_PAYLOAD.repository.name }} v${{ steps.version.outputs.version }} to crates.io successfully!'
        continue-on-error: true
